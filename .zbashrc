echo 'include .zbashrc'


# メモ：このcacheは消しても問題ない
# //sudo rm -rf /System/Library/Caches/* /Library/Caches/* ~/Library/Caches/*

#####################################################################################################
# zsh共通設定
#####################################################################################################

# 慣れてから考える標準設定
bindkey -e
#bindkey -v

# ヒストリの設定
HISTFILE=~/.zsh_history
HISTSIZE=1000000
SAVEHIST=1000000

# ディレクトリの履歴
# cd のあとでtabを押したときに履歴で移動できる
setopt auto_pushd

# 日本語ファイル名を表示可能にする
setopt print_eight_bit

# beep を無効にする
setopt no_beep

## "~hoge" が特定のパス名に展開されるようにする（ブックマークのようなもの）
## 例： cd ~hoge と入力すると /long/path/to/hogehoge ディレクトリに移動
# hash -d hoge=/long/path/to/hogehoge

# pushd したとき、ディレクトリがすでにスタックに含まれていればスタックに追加しない
setopt pushd_ignore_dups

# どういう意味を持つかは `man zshexpn` の FILENAME GENERATION を参照
setopt extended_glob


# ctrl+f, ctrl+<-で次の単語に移動
#TODO

# ctrl+b, ctrl+->で次の単語に移動
#TODO

# ^R で履歴検索をするときに * でワイルドカードを使用出来るようにする
bindkey '^R' history-incremental-pattern-search-backward

# プロンプト系
# 参考）
# http://tkengo.github.io/blog/2013/05/12/zsh-vcs-info/
# http://www.sirochro.com/note/terminal-zsh-prompt-customize/
autoload -Uz vcs_info
setopt prompt_subst
zstyle ':vcs_info:git:*' check-for-changes true
zstyle ':vcs_info:git:*' stagedstr "%F{yellow}!"
zstyle ':vcs_info:git:*' unstagedstr "%F{red}+"
zstyle ':vcs_info:*' formats "%F{green}%c%u[%b]%f"
zstyle ':vcs_info:*' actionformats '[%b|%a]'
precmd () { vcs_info }

RPROMPT="%{${fg[blue]}%}[%~]%{${reset_color}%}"
RPROMPT=$RPROMPT'${vcs_info_msg_0_}'
PROMPT="sv.junic$ "

# 色の変更
export LSCOLORS=gxfxcxdxbxegedabagacad

#####################################################################################################
# function
#####################################################################################################


# デフォルトバージョンのNodeを使う
export NVM_DIR="$HOME/.nvm"
if [ -f "$NVM_DIR/alias/default" ]; then
  _NVM_DEFAULT_VER="$(cat "$NVM_DIR/alias/default")"
  _NVM_BIN="$NVM_DIR/versions/node/${_NVM_DEFAULT_VER}/bin"
  if [ -d "$_NVM_BIN" ]; then
    case ":$PATH:" in
      *":$_NVM_BIN:"*) ;;  # 既に入っていたらスキップ
      *) export PATH="$_NVM_BIN:$PATH" ;;
    esac
  fi
fi

# load nvm
function load_npm () {
  echo "add PATH for node.js"
  export PATH="/usr/local/bin:$PATH:/usr/local/sbin"

  source ~/.nvm/nvm.sh
  #nvm use v20.18.0
  nvm use --lts

  alias node="node --experimental-modules"
  echo "set NODE_PATH for node.js"
  export NODE_PATH=$npm_dir
}

# 不要ファイルを一度に削除したかった。
function ccc () {
  rm `find . -name '.DS*'`
  rm `find . -name '*.swp'`
  rm `find . -name 'Thumbs.db'`
  return
}

# scss 単体コンパイル
function scss1compile () {
  filename=$(echo $1 | sed 's/.scss$//g')
  scss --compass ${filename}.scss ${filename}.css -C --sourcemap=none --style compressed
  return
}
function scss1watch () {
  filename=$(echo $1 | sed 's/.scss$//g')
  scss --watch${filename}.scss:${filename}.css -C --sourcemap=none --style compressed
  return
}
function scsswwatch () {
  input=$1
  output=$2
  scss --watch ${input}:${output} -C --sourcemap=none --style compressed
  return
}
function up() {
  if [ ! -z $1 ]; then
    level=$1
  else
    level=1
  fi

  expr $level + 1 > /dev/null 2>&1
  ret=$?

  cmd='cd ./'

  if [ $ret -lt 2 ]; then
    for i in `seq 1 $level`
    do
      cmd="$cmd../"
    done
    eval $cmd;
  fi
}

# ag
function agg() {
  if [ ! -z $1 ]; then
    path=$1
  else
    path=''
  fi

  eval 'ag -l -u --depth -1 '${path}' ./*';
}


#####################################################################################################
# cordova
#####################################################################################################
# export PATH="$PATH:/Applications/AndroidSDK/adt-bundle-mac-x86_64-20140321/sdk/tools/"
# export PATH="$PATH:/Applications/AndroidSDK/adt-bundle-mac-x86_64-20140321/sdk/platform-tools/"


#####################################################################################################
# nginx
#####################################################################################################
# export PATH="/usr/local/nginx/sbin:$PATH"


#####################################################################################################
# git
#####################################################################################################
# git config --global credential.helper cache --timeout=86400
# git config --global core.editor /Applications/MacVim.app/Contents/MacOS/Vim
# 空コミット
# git commit --allow-empty -m "make pull request"

#差分ファイル出すとき用
# git_diff_archive 識別子1 識別子2
. ~/zsh/git_diff_archive.zsh

# peco,vim,pt
. ~/bash/ptvim.sh
git config --global color.ui auto
git config --global alias.co checkout
git config --global alias.ci commit
#git config --global alias.st status
git config --global alias.br branch
git config --global alias.hist 'log --pretty=format:\"%h %ad | %s%d [%an]\" --graph --date=short'

git config --global alias.st  'status --branch --short'
git config --global alias.sl  'log --all --branches --decorate --graph --oneline'
git config --global alias.log 'log --all --branches --graph'

git config --global core.pager delta
git config --global interactive.diffFilter "delta --color-only"
git config --global delta.navigate true
git config --global delta.side-by-side true

#git config --global alias.log 'log --all --branches --graph'
#git show-branch --merge-base master HEAD
#git diff `git show-branch --merge-base master HEAD` HEAD

function gitpush_current_branch() {
  branch=$(git rev-parse --abbrev-ref HEAD)
  if [ -n "$branch" ]; then
    git push -u origin "$branch"
  else
    echo "Not in a git repository."
  fi
}
alias gitp='gitpush_current_branch'

#####################################################################################################
# zsh
#####################################################################################################
# zsh


#####################################################################################################
# nvm
#####################################################################################################
function npm () {
  echo 'npm function'
  unset -f npx
  unset -f npm
  load_npm

  if [ ! -z $1 ]; then
    npm $@
  fi
}

function npx () {
  echo 'npm function'
  unset -f npx
  unset -f npm
  load_npm

  if [ ! -z $1 ]; then
    npx $@
  fi
}

function node_vi () {
  unalias vi
  alias vi='nvim'

  if ! (type "node" > /dev/null 2>&1) ; then
    load_npm
  fi

  if [ ! -z $1 ]; then
    nvim $@
  else
    nvim
  fi
}

#####################################################################################################
# tmux
#####################################################################################################

if [[ -n "$ITERM_SESSION_ID" ]] && ! [ -n "$TMUX" ]; then
  if ! [ -n "$TMUX" ]; then
    #nvm use --lts
    npm_dir=${NVM_PATH}_modules
    tmux a -d || tmux
  else
    . ~/bash/tmux/alias.sh
  fi
fi

#####################################################################################################
# peco
#####################################################################################################
function cdf () {
  local dir=$(find ./* -type f | grep -v 'node_modules' | peco)
  if [ ! -z "$dir" ] ; then
    vim "$dir"
  fi
}

function cdd {
  local dir=$(find ./* -type d | grep -v 'node_modules' | peco)
  if [ ! -z "$dir" ] ; then
      cd "$dir"
  fi
}

function cddf {
  local dir=$(find ./* -type d | peco)
  if [ ! -z "$dir" ] ; then
      cd "$dir"
  fi
}

function cdff () {
  local dir=$(find ./* -type f | peco)
  if [ ! -z "$dir" ] ; then
    vim "$dir"
  fi
}

function switch_aws_profile() {
  local profile
  profile=$(awk -F'[][]' '/\[.*\]/{print $2}' ~/.aws/credentials | peco)

  if [ -n "$profile" ]; then
    export AWS_PROFILE=$profile
    echo "Switched AWS profile to: $AWS_PROFILE"
  else
    echo "No profile selected."
  fi
}

function switch_venv() {
  local VENV_DIR="$HOME/.venv"

  if [ ! -d "$VENV_DIR" ]; then
    echo "Virtual environments directory not found: $VENV_DIR"
    return 1
  fi

  local VENV=$(ls "$VENV_DIR" | peco)

  if [ -z "$VENV" ]; then
    echo "No virtual environment selected."
    return 0
  fi

  local VENV_PATH="$VENV_DIR/$VENV/bin/activate"
  if [ -f "$VENV_PATH" ]; then
    source "$VENV_PATH"
    echo "Switched to virtual environment: $VENV"
  else
    echo "Activate script not found for: $VENV"
    return 1
  fi
}

function gitdiff_select_commit() {
  local commit=$(git log --oneline | peco | awk '{print $1}')
  if [ -n "$commit" ]; then
    git diff "$commit"
  fi
}

function gitshow_select_commit() {
  emulate -L zsh
  setopt pipefail

  # コミット選択（pager無効でpecoに流す）
  local line commit
  line=$(
    git --no-pager log --oneline --decorate --all \
    | peco --prompt "commit to show > "
  )

  # キャンセル対策
  [[ -z "$line" ]] && { echo "Canceled."; return 1; }

  # 先頭のハッシュだけ抜く
  commit="${line%% *}"

  # 選んだコミットの差分（メッセージ＋patch）
  git show "$commit" -- "$@"
}

function nvim_swap_clean() {
  rm -v ~/.local/state/nvim/swap/*.swp 2>/dev/null
}

#####################################################################################################
# github
#####################################################################################################
fpath=(~/zsh/$fpath)
autoload -U compinit
compinit -u

#####################################################################################################
# fake-dev
#####################################################################################################
#alias fake-dev="nginx -p . -c ~/.fake-dev.conf"


#####################################################################################################
# alias
#####################################################################################################
case "${OSTYPE}" in
darwin*)
  alias ls="ls -G"
  alias ll="ls -lG"
  alias la="ls -laG"
  alias openf='sh ~/bash/openf'
  ;;
linux*)
  alias ls='ls --color'
  alias ll='ls -l --color'
  alias la='ls -la --color'
  ;;
esac
alias cdc='cd `pwd -P`'
#alias vi='vim'
#alias vi='nvim'
alias vi='node_vi'
alias vimdiff='nvim -d '

# github
alias gitst='git st'
#alias gitdiff='git difftool --tool=vimdiff --no-prompt'
alias gitlmm='git log origin/master..master'
alias gitlg='git log --graph'
function gitbase () {
  git show-branch | grep '*' | grep -v "$(git rev-parse --abbrev-ref HEAD)" | head -1 | awk -F'[]~^[]' '{print $2}'
}
alias gitadd='git add -A -- . ":(exclude).github"'

# NOTE: stash忘れがち、3ヶ月使わなかったら消す
alias gitStashlis='git stash list'               # stash確認用
alias gitStashShow='git stash show -p stash@{0}' # 差分内容をチェック
alias gitStashSave='git stash save'              # "作業内容メモ" のようにメッセージをつける
alias gitStashBranch='git stash branch '         # 新しいブランチ名 で stash から直接作業再開（安全で便利！）

#alias adbDebug='sh ~/bash/androidDebug.sh'
alias tmux-session-clear='tmux kill-session -a'

# ディレクトリの容量表示
alias dud='du -d 1 -h '

alias gitfilemode='git config core.filemode'

alias spwget='wget --user-agent="Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1" '
# [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

alias vimdiff='nvim -d'

alias repo='function _repo() {
    if git status &>/dev/null; then
        local branch
        branch=$(git branch -a | sed "s/^[* ] //" | sed "s/remotes\/origin\///" | sort -u | grep -v "HEAD" | peco)
        if [ -n "$branch" ]; then
            git checkout "$branch"
        fi
    else
        echo "This is not a git repository."
    fi
}; _repo'

alias c5='copilot --banner --model gpt-5'
alias ch='copilot --banner --model claude-haiku-4.5'
alias cs='copilot --banner --model claude-sonnet-4.5'

alias remove-swp='rm ~/.local/state/nvim/swap/.*'

# ~/.zshrc などに追記
function gitdiff() {
  emulate -L zsh
  setopt pipefail
  setopt localoptions noglob   # [] を含むパスでも展開されない

  # 使い方
  if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Usage: gitdiff [<path> ...]"
    echo "Choose a base branch with peco and show 'git diff <base> -- <path...>'"
    return 0
  fi

  # Git リポジトリチェック
  if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Not a git repository."
    return 1
  fi

  # peco チェック
  if ! command -v peco >/dev/null 2>&1; then
    echo "peco is not installed (brew install peco などで導入してください)"
    return 1
  fi

  # 現在ブランチ
  local current
  current=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

  # 候補一覧（ローカル＆リモート、HEADは除外、現在ブランチも除外）
  local base
  base=$(
    git for-each-ref --format='%(refname:short)' refs/heads refs/remotes \
    | grep -vE '/HEAD$' \
    | grep -v "^${current}\$" \
    | sort -u \
    | peco --prompt "base branch to diff against > "
  )

  [[ -z "$base" ]] && { echo "Canceled."; return 1; }

  # 引数が無ければリポジトリ全体、あればそのパスだけ
  if (( $# == 0 )); then
    git diff "$base"
  else
    git diff "$base" -- "$@"
  fi
}

# gh のユーザ切替を行う
# - 事前要件: gh, peco がインストールされていること
# - 入力: ~/.config/gh/hosts.yml の github.com.users を peco で選択
# - 挙動: 選択したユーザで `gh auth switch --hostname github.com --user <user>` を実行
# - 失敗時: エラーメッセージを出力して非ゼロを返す
ghswitch() {
  if ! command -v gh >/dev/null 2>&1; then
    echo "gh コマンドが見つかりません（brew install gh など）"
    return 1
  fi

  HOSTS_FILE="$HOME/.config/gh/hosts.yml"
  if [ ! -f "$HOSTS_FILE" ]; then
    echo "gh の設定ファイルが見つかりません: $HOSTS_FILE"
    return 1
  fi

  if ! command -v peco >/dev/null 2>&1; then
    echo "peco が見つかりません（brew install peco など）"
    return 1
  fi

  users=$(awk '
    /^[[:space:]]*github.com:/{found=1; next}
    found && /^[[:space:]]*users:/{userblock=1; next}
    # ユーザ名行は「先頭空白 + キー + コロン + （空白のみ）行末」のみを許可する
    userblock && /^[[:space:]]+[^[:space:]]+:[[:space:]]*$/{
      line=$0
      sub(/^[[:space:]]+/,"",line)
      sub(/:[[:space:]]*$/,"",line)
      gsub(/^"|"$/,"",line)
      print line
      next
    }
    userblock && !/^[[:space:]]+[^[:space:]]+:[[:space:]]*$/ {exit}
  ' "$HOSTS_FILE" | sed 's/^"//;s/"$//' | sort -u)

  # fallback: top-level user if users block not found
  if [ -z "$users" ]; then
    users=$(awk '/^[[:space:]]*github.com:/{found=1} found && /^[[:space:]]*user:/{print $2; exit}' "$HOSTS_FILE" | sed 's/^"//;s/"$//')
  fi

  if [ -z "$users" ]; then
    echo "github.com に紐づくユーザが見つかりません: $HOSTS_FILE"
    return 1
  fi

  user=$(printf "%s\n" "$users" | peco --prompt "gh user > ")
  if [ -z "$user" ]; then
    echo "Canceled."
    return 1
  fi

  gh auth switch --hostname github.com --user "$user"
}
